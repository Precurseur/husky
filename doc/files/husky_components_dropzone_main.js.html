<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>husky_components/dropzone/main.js - husky</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="husky"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.7.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AutoComplete.html">AutoComplete</a></li>
            
                <li><a href="../classes/AutoCompleteList.html">AutoCompleteList</a></li>
            
                <li><a href="../classes/CKEditor.html">CKEditor</a></li>
            
                <li><a href="../classes/Column-Options.html">Column-Options</a></li>
            
                <li><a href="../classes/ColumnNavigation.html">ColumnNavigation</a></li>
            
                <li><a href="../classes/DataGrid.html">DataGrid</a></li>
            
                <li><a href="../classes/Dependant Select.html">Dependant Select</a></li>
            
                <li><a href="../classes/DropdownPagination (Datagrid Decorator).html">DropdownPagination (Datagrid Decorator)</a></li>
            
                <li><a href="../classes/Dropzone.html">Dropzone</a></li>
            
                <li><a href="../classes/GroupView (Datagrid Decorator).html">GroupView (Datagrid Decorator)</a></li>
            
                <li><a href="../classes/Input.html">Input</a></li>
            
                <li><a href="../classes/Label.html">Label</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Matcher.html">Matcher</a></li>
            
                <li><a href="../classes/Overlay.html">Overlay</a></li>
            
                <li><a href="../classes/Process.html">Process</a></li>
            
                <li><a href="../classes/Search.html">Search</a></li>
            
                <li><a href="../classes/Select.html">Select</a></li>
            
                <li><a href="../classes/TableView (Datagrid Decorator).html">TableView (Datagrid Decorator)</a></li>
            
                <li><a href="../classes/Tabs.html">Tabs</a></li>
            
                <li><a href="../classes/ThumbnailView (Datagrid Decorator).html">ThumbnailView (Datagrid Decorator)</a></li>
            
                <li><a href="../classes/Toggler.html">Toggler</a></li>
            
                <li><a href="../classes/Toolbar.html">Toolbar</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/husky_components_auto-complete.html">husky/components/auto-complete</a></li>
            
                <li><a href="../modules/husky_components_auto-complete-list.html">husky/components/auto-complete-list</a></li>
            
                <li><a href="../modules/husky_components_column-navigation.html">husky/components/column-navigation</a></li>
            
                <li><a href="../modules/husky_components_column-options.html">husky/components/column-options</a></li>
            
                <li><a href="../modules/husky_components_dropzone.html">husky/components/dropzone</a></li>
            
                <li><a href="../modules/husky_components_input.html">husky/components/input</a></li>
            
                <li><a href="../modules/husky_components_label.html">husky/components/label</a></li>
            
                <li><a href="../modules/husky_components_matcher.html">husky/components/matcher</a></li>
            
                <li><a href="../modules/husky_components_overlay.html">husky/components/overlay</a></li>
            
                <li><a href="../modules/husky_components_process.html">husky/components/process</a></li>
            
                <li><a href="../modules/husky_components_toolbar.html">husky/components/toolbar</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: husky_components/dropzone/main.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * This file is part of Husky frontend development framework.
 *
 * (c) MASSIVE ART WebServices GmbH
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 *
 * @module husky/components/dropzone
 */

/**
 * @class Dropzone
 * @constructor
 *
 * @params {Object} [options] Configuration object
 * @params {String} [options.titleKey] The title to display if no items are dropped (can be a translation key)
 * @params {String} [options.descriptionKey] The description to display if no items are dropped (can be a translation key)
 * @params {String} [options.descriptionIcon] The icon to display if no items are dropped
 * @params {String} [options.cancelLoadingIcon] the icon which gets displayed while a file item gets uploaded
 * @params {String} [options.method] method to use for uploading &#x27;PUT&#x27; or &#x27;POST&#x27;
 * @params {String} [options.url] url to upload the files to
 * @params {String} [options.paramName] the name of the parameter which will contain the file(s). Note that if uploadMultiple is set to true the parameter Name gets extended with &#x27;[]&#x27;
 * @params {Object} [options.headers] additional headers to pass with each request
 * @params {Boolean} [options.uploadMultiple] if true a request can upload multiple files
 * @params {Number} [options.maxFiles] defines the maximum of files in the dropzone
 * @params {Function} [options.successCallback] callback which gets called if a file got successfully uploaded. First parameter is the file, the second the response
 * @params {Function} [options.beforeSendingCallback] callback which gets called before a file gets uploaded. First parameter is the file.
 * @params {Function} [options.removeFileCallback] callback which gets called after a file got removed. First parameter is the file.
 * @params {Function} [options.afterDropCallback] callback which gets called after a file got dropped. Has to return a promise. If the promise gets resolved the file gets uploaded
 * @params {Object} [options.pluginOptions] Options to pass to the dropzone-plugin to completely override all options set by husky. Use with care.
 * @params {Boolean} [options.showOverlay] if true the dropzone will be displayed in an overlay if its not visible any more or the passed scroll-top is reached
 * @params {String} [options.skin] skin class for the dropzone. currently available: &#x27;small&#x27; or &#x27;&#x27; (default)
 * @params {Boolean} [options.keepFilesAfterSuccess] True to not slide the files away after uploading them successfully
 */
define([], function () {

    &#x27;use strict&#x27;;

    var defaults = {
            instanceName: &#x27;undefined&#x27;,
            titleKey: &#x27;sulu.upload.dropzone-title&#x27;,
            descriptionKey: &#x27;sulu.upload.dropzone-desc&#x27;,
            descriptionIcon: &#x27;cloud-upload&#x27;,
            cancelLoadingIcon: &#x27;repeat&#x27;,
            method: &#x27;POST&#x27;,
            url: &#x27;/&#x27;,
            paramName: &#x27;file&#x27;,
            headers: {
                // to prevent a 406 error-response
                &#x27;Accept&#x27;: &#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;
            },
            uploadMultiple: false,
            successCallback: null,
            beforeSendingCallback: null,
            removeFileCallback: null,
            afterDropCallback: null,
            pluginOptions: {},
            maxFiles: null,
            fadeOutDuration: 200, //ms
            fadeOutDelay: 1500, //ms
            showOverlay: true,
            keepFilesAfterSuccess: false,
            skin: &#x27;&#x27;
        },

        constants = {
            contianerClass: &#x27;husky-dropzone&#x27;,
            descriptionClass: &#x27;description&#x27;,
            uploadedItemContainerClass: &#x27;upload-items&#x27;,
            uploadItemClass: &#x27;item&#x27;,
            droppedClass: &#x27;dropped&#x27;
        },

        /** templates for component */
            templates = {
            basic: [
                &#x27;&lt;div class=&quot;&#x27; + constants.descriptionClass + &#x27;&quot;&gt;&#x27;,
                &#x27;&lt;div class=&quot;fa-&lt;%= icon %&gt; icon&quot;&gt;&lt;/div&gt;&#x27;,
                &#x27;&lt;span class=&quot;title&quot;&gt;&lt;%= title %&gt;&lt;/span&gt;&#x27;,
                &#x27;&lt;span class=&quot;addition&quot;&gt;&lt;%= description %&gt;&lt;/span&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;,
                &#x27;&lt;div class=&quot;&#x27; + constants.uploadedItemContainerClass + &#x27;&quot;&gt;&lt;/div&gt;&#x27;
            ].join(&#x27;&#x27;),
            uploadItem: [
                &#x27;&lt;div class=&quot;&#x27; + constants.uploadItemClass + &#x27;&quot;&gt;&#x27; +
                    &#x27;&lt;div class=&quot;loading-content&quot;&gt;&#x27;,
                &#x27;&lt;div class=&quot;fa-&lt;%= cancelIcon %&gt; icon&quot; data-dz-remove&gt;&lt;/div&gt;&#x27;,
                &#x27;&lt;div class=&quot;file-size&quot; data-dz-size&gt;&lt;/div&gt;&#x27;,
                &#x27;&lt;div class=&quot;progress&quot;&gt;&#x27;,
                &#x27;&lt;div class=&quot;bar&quot; data-dz-uploadprogress&gt;&lt;/div&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;,
                &#x27;&lt;div class=&quot;success-content&quot;&gt;&#x27;,
                &#x27;&lt;div class=&quot;image&quot;&gt;&#x27;,
                &#x27;&lt;img data-dz-thumbnail /&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;,
                &#x27;&lt;div class=&quot;fa-check tick&quot;&gt;&lt;/div&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;,
                &#x27;&lt;/div&gt;&#x27;
            ].join(&#x27;&#x27;)
        },

        /**
         * namespace for events
         * @type {string}
         */
            eventNamespace = &#x27;husky.dropzone.&#x27;,

        /**
         * raised after initialization process
         * @event husky.dropzone.&lt;instance-name&gt;.initialize
         */
            INITIALIZED = function () {
            return createEventName.call(this, &#x27;initialized&#x27;);
        },

        /**
         * raised before sending a file
         * @event husky.dropzone.&lt;instance-name&gt;.uploading
         * @param {Object} the file
         */
            UPLOADING = function () {
            return createEventName.call(this, &#x27;uploading&#x27;);
        },

        /**
         * raised after file got successfully uploaded
         * @event husky.dropzone.&lt;instance-name&gt;.success
         * @param {Object} the file
         * @param {Object} the response
         */
            SUCCESS = function () {
            return createEventName.call(this, &#x27;success&#x27;);
        },

        /**
         * listens on and opens the data-source folder-overlay
         * @event husky.dropzone.&lt;instance-name&gt;.open-data-source
         */
            OPEN_DATA_SOURCE = function () {
            return createEventName.call(this, &#x27;open-data-source&#x27;);
        },

        /**
         * listens on and prevents an overlay with the dropzone from poping up
         * @event husky.dropzone.&lt;instance-name&gt;.open-data-source
         */
            LOCK_POPUP = function () {
            return createEventName.call(this, &#x27;lock-popup&#x27;);
        },

        /**
         * listens on and enables overlays with the dropzone to pop up
         * @event husky.dropzone.&lt;instance-name&gt;.open-data-source
         */
            UNLOCK_POPUP = function () {
            return createEventName.call(this, &#x27;unlock-popup&#x27;);
        },

        /**
         * raised after files got uploaded and faded out from the dropzone
         * @event husky.dropzone.&lt;instance-name&gt;.files-added
         * @param {Array} all newly added files
         */
            FILES_ADDED = function () {
            return createEventName.call(this, &#x27;files-added&#x27;);
        },

        /**
         * listens on and changes the url of the dropzone
         * @event husky.dropzone.&lt;instance-name&gt;.change-url
         * @param {String} the new url
         */
            CHANGE_URL = function () {
            return createEventName.call(this, &#x27;change-url&#x27;);
        },

        /** returns normalized event names */
            createEventName = function (postFix) {
            return eventNamespace + (this.options.instanceName ? this.options.instanceName + &#x27;.&#x27; : &#x27;&#x27;) + postFix;
        };

    return {

        /**
         * Initialize component
         */
        initialize: function () {
            this.sandbox.logger.log(&#x27;initialize&#x27;, this);

            // merge defaults, type defaults and options
            this.options = this.sandbox.util.extend(true, {}, defaults, this.options);
            this.dropzone = null;
            this.$dropzone = null;
            this.lastUploadedFile = null;
            this.overlayOpened = false;
            this.lockPopUp = false;
            this.url = this.options.url;
            this.filesDropped = 0;

            this.bindCustomEvents();
            this.render();
            this.bindDomEvents();

            this.sandbox.emit(INITIALIZED.call(this));
        },

        /**
         * Binds dom related events
         */
        bindDomEvents: function () {
            // delegate click on elements children to element
            this.sandbox.dom.on(this.sandbox.dom.find(&#x27;*&#x27;, this.$dropzone), &#x27;click&#x27;, function (event) {
                this.sandbox.dom.stopPropagation(event);
                this.sandbox.dom.trigger(this.$dropzone, &#x27;click&#x27;);
            }.bind(this));

            if (this.options.showOverlay) {
                this.sandbox.dom.on(this.sandbox.dom.$document, &#x27;dragenter&#x27;, function () {
                    this.openOverlay();
                }.bind(this));
            }
        },

        /**
         * Binds custom-related events
         */
        bindCustomEvents: function () {
            // opens the data-source folder-overlay
            this.sandbox.on(OPEN_DATA_SOURCE.call(this), function () {
                this.sandbox.dom.trigger(this.$dropzone, &#x27;click&#x27;);
            }.bind(this));

            // change the url
            this.sandbox.on(CHANGE_URL.call(this), function(url) {
                this.url = url;
            }.bind(this));

            if (this.options.showOverlay) {
                this.sandbox.on(LOCK_POPUP.call(this), function() {
                    this.lockPopUp = true;
                }.bind(this));

                this.sandbox.on(UNLOCK_POPUP.call(this), function() {
                    this.lockPopUp = false;
                }.bind(this));
            }
        },

        /**
         * Opens the dropzone in an overlay
         */
        openOverlay: function () {
            // open the overlay only if it&#x27;s not already opened and if the dropzone is not visible
            if (this.overlayOpened === false &amp;&amp; this.lockPopUp === false) {
                // set height of components element to prevent the site from bumping
                this.sandbox.dom.height(this.$el, this.sandbox.dom.outerHeight(this.$el));

                var $container = this.sandbox.dom.createElement(&#x27;&lt;div/&gt;&#x27;);
                this.sandbox.dom.append(this.$el, $container);
                this.sandbox.start([
                    {
                        name: &#x27;overlay@husky&#x27;,
                        options: {
                            el: $container,
                            openOnStart: true,
                            removeOnClose: true,
                            draggable: false,
                            data: this.$dropzone,
                            instanceName: &#x27;dropzone-&#x27; + this.options.instanceName,
                            skin: &#x27;dropzone&#x27;,
                            smallHeader: true,
                            closeCallback: function () {
                                this.sandbox.dom.append(this.$el, this.$dropzone);
                                this.sandbox.dom.height(this.$el, &#x27;&#x27;);
                                this.overlayOpened = false;
                            }.bind(this)
                        }
                    }
                ]);
                this.overlayOpened = true;
            }
        },

        /**
         * Renders the component
         */
        render: function () {
            this.$dropzone = this.sandbox.dom.createElement(&#x27;&lt;div class=&quot;&#x27; + constants.contianerClass + &#x27;&quot;/&gt;&#x27;);
            this.sandbox.dom.html(this.$dropzone, this.sandbox.util.template(templates.basic)({
                description: this.sandbox.translate(this.options.descriptionKey),
                title: this.sandbox.translate(this.options.titleKey),
                icon: this.options.descriptionIcon,
                instanceName: this.options.instanceName
            }));
            this.sandbox.dom.addClass(this.$dropzone, this.options.skin);
            this.sandbox.dom.append(this.$el, this.$dropzone);
            this.startDropzone();
        },

        /**
         * Starts the dropzone component
         */
        startDropzone: function () {
            var that = this,
                options = {
                    url: this.options.url,
                    method: this.options.method,
                    paramName: this.options.paramName,
                    uploadMultiple: this.options.uploadMultiple,
                    maxFiles: this.options.maxFiles,
                    headers: this.options.headers,
                    autoProcessQueue: !this.options.afterDropCallback,
                    previewTemplate: this.sandbox.util.template(templates.uploadItem)({
                        cancelIcon: this.options.cancelLoadingIcon
                    }),
                    previewsContainer: this.sandbox.dom.find(&#x27;.&#x27; + constants.uploadedItemContainerClass, this.$dropzone)[0],
                    init: function () {
                        // store dropzone context
                        that.dropzone = this;

                        this.on(&#x27;drop&#x27;, function(event) {
                            this.filesDropped = event.dataTransfer.files.length;
                        }.bind(that));

                        // gets called if file gets added (drop or via the upload window)
                        this.on(&#x27;addedfile&#x27;, function (file) {
                            that.sandbox.dom.addClass(that.$dropzone, constants.droppedClass);

                            // call the after-drop callback on the last file
                            if (typeof that.options.afterDropCallback === &#x27;function&#x27;) {
                                if (this.files.length === that.filesDropped) {
                                    that.options.afterDropCallback(file).then(function() {
                                        that.sandbox.util.foreach(this.files, function(file) {
                                            that.sandbox.util.delay(this.processFile.bind(this, file), 0);
                                        }.bind(this));
                                    }.bind(this));
                                }
                            }

                            // prevent the the upload window to open on click on the preview item
                            that.sandbox.dom.on(file.previewElement, &#x27;click&#x27;, function (event) {
                                this.sandbox.dom.stopPropagation(event);
                            }.bind(that));
                        });

                        // gets called before the file is sent
                        this.on(&#x27;sending&#x27;, function (file) {
                            if (typeof this.options.beforeSendingCallback === &#x27;function&#x27;) {
                                this.options.beforeSendingCallback(file);
                            } else {
                                this.sandbox.emit(UPLOADING.call(this), file);
                            }
                        }.bind(that));

                        // gets called if the file was uploaded successfully
                        this.on(&#x27;success&#x27;, function (file, response) {
                            if (this.lastUploadedFile !== file) {
                                file.response = response;
                                this.lastUploadedFile = file;
                                if (typeof this.options.successCallback === &#x27;function&#x27;) {
                                    this.options.successCallback(file, response);
                                } else {
                                    this.sandbox.emit(SUCCESS.call(this), file, response);
                                }
                                this.removeAllFiles(this.options.keepFilesAfterSuccess);
                            }
                        }.bind(that));

                        // gets called if a file gets removed from the zone
                        this.on(&#x27;removedfile&#x27;, function (file) {
                            if (typeof this.options.removeFileCallback === &#x27;function&#x27;) {
                                this.options.removeFileCallback(file);
                            }
                        }.bind(that));

                        // gets called if all files are removed from the zone
                        this.on(&#x27;reset&#x27;, function () {
                            if (this.options.keepFilesAfterSuccess === false) {
                                this.sandbox.dom.removeClass(this.$dropzone, constants.droppedClass);
                            }
                        }.bind(that));

                        // enables the to change the url dynamically
                        this.on(&#x27;processing&#x27;, function () {
                            this.options.url = that.url;
                        });
                    }
                };

            // merge the default plugin options with with passed ones
            options = this.sandbox.util.extend(true, {}, options, this.options.pluginOptions);
            this.sandbox.dropzone.initialize(this.$dropzone, options);
        },

        /**
         * Removes all files from the dropzone
         * but only if all dropped files got uploaded
         * @param keepDom {Boolean} true to keep the dom like it is
         */
        removeAllFiles: function (keepDom) {
            // if all files got uploaded
            if (this.dropzone.getUploadingFiles.call(this.dropzone).length === 0) {
                if (keepDom === true) {
                    this.afterFadeOut(true);
                } else {
                    this.sandbox.util.delay(
                    function () {
                        this.sandbox.dom.fadeOut(
                            this.sandbox.dom.find(&#x27;.&#x27; + constants.uploadItemClass, this.$dropzone),
                            this.options.fadeOutDuration,
                            function () {
                                if (this.sandbox.dom.find(&#x27;.&#x27; + constants.uploadItemClass + &#x27;:animated&#x27;, this.$dropzone).length === 0) {
                                    this.afterFadeOut();
                                }
                            }.bind(this)
                        );
                    }.bind(this),
                    this.options.fadeOutDelay
                );
                }
            }
        },

        /**
         * Function gets called after all dropped files
         * have faded out
         * @param keepDom {Boolean} true to keep the dom like it is
         */
        afterFadeOut: function (keepDom) {
            if (this.overlayOpened === true) {
                this.sandbox.emit(&#x27;husky.overlay.dropzone-&#x27;+ this.options.instanceName +&#x27;.close&#x27;);
            }
            this.sandbox.emit(FILES_ADDED.call(this), this.getResponseArray(this.dropzone.files));
            this.filesDropped = 0;
            if (keepDom === true) {
                this.dropzone.files = [];
            } else {
                this.sandbox.dom.removeClass(this.$dropzone, constants.droppedClass);
                this.dropzone.removeAllFiles();
            }
        },

        /**
         * Returns an array with responses for a given array of files
         * @param files {Array} array of files with response properties
         * @returns {Array} array of responses
         */
        getResponseArray: function (files) {
            var arrReturn = [], i, length;
            for (i = -1, length = files.length; ++i &lt; length;) {
                arrReturn.push(files[i].response);
            }
            return arrReturn;
        }
    };

});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
